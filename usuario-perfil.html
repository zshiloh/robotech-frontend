<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - ROBOTECH</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --navbar-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* NAVBAR MODERNA */
        .navbar-modern {
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            height: var(--navbar-height);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 0 2rem;
        }

        .navbar-brand-modern {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
        }

        .navbar-brand-modern .logo-circle {
            width: 45px;
            height: 45px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .navbar-brand-modern .logo-circle i {
            color: white;
            font-size: 1.5rem;
        }

        .navbar-brand-modern .brand-text {
            font-size: 1.5rem;
            font-weight: 900;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .notification-btn {
            position: relative;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .notification-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .notification-btn:hover i {
            color: white;
        }

        .notification-btn i {
            color: #6c757d;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--primary-gradient);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.2rem 0.4rem;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-menu:hover {
            background: var(--primary-color);
        }

        .user-menu:hover .user-name,
        .user-menu:hover i {
            color: white;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 10px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .user-name {
            font-weight: 600;
            color: #2d3748;
            transition: all 0.3s;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            min-width: 280px;
            border: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-radius: 16px;
            margin-top: 0.75rem !important;
            padding: 0.5rem;
        }

        .dropdown-menu-end {
            right: 0 !important;
            left: auto !important;
        }

        .dropdown-item {
            transition: all 0.3s;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-weight: 600;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .dropdown-item.text-danger:hover {
            background: rgba(244, 67, 54, 0.1);
        }

        /* Dropdown de Notificaciones */
        .notifications-dropdown {
            width: 400px !important;
            max-height: 500px;
            overflow-y: auto;
            right: 0 !important;
            left: auto !important;
            transform-origin: top right !important;
        }

        .notifications-header {
            padding: 1rem;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: #2d3748;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s;
            cursor: pointer;
        }

        .notification-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .notification-item.unread {
            background: rgba(102, 126, 234, 0.05);
            border-left: 3px solid #667eea;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            line-height: 1.3;
        }

        .notification-message {
            font-size: 0.8rem;
            color: #718096;
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }

        .notification-time {
            font-size: 0.7rem;
            color: #718096;
        }

        .notification-badge-new {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.15rem 0.4rem;
            border-radius: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .notifications-footer {
            padding: 0.75rem 1rem;
            text-align: center;
            border-top: 2px solid #f0f0f0;
        }

        .notifications-footer a {
            color: #667eea;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
        }

        .notifications-footer a:hover {
            color: #764ba2;
        }

        .empty-notifications {
            padding: 3rem 2rem;
            text-align: center;
            color: #718096;
        }

        .empty-notifications i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* MAIN CONTENT */
        .main-content-modern {
            margin-top: var(--navbar-height);
            padding: 2.5rem;
            min-height: calc(100vh - var(--navbar-height));
        }

        /* PAGE HEADER */
        .page-header {
            background: white;
            border-radius: 20px;
            padding: 2rem 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
            animation: slideDown 0.6s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header h1 {
            font-size: 2.2rem;
            font-weight: 900;
            color: #2d3748;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-header h1 i {
            color: var(--primary-color);
        }

        /* CARDS MODERNAS */
        .card-modern {
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
            border: none;
            margin-bottom: 2rem;
            animation: fadeInUp 0.5s ease;
            overflow: hidden;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-modern .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 3px solid #f0f0f0;
            padding: 1.5rem 2rem;
            border-radius: 0;
        }

        .card-modern .card-header h5,
        .card-modern .card-header h6 {
            font-weight: 700;
            color: #2d3748;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            justify-content: space-between;
        }

        .card-modern .card-header h5 i,
        .card-modern .card-header h6 i {
            color: var(--primary-color);
        }

        .card-modern .card-body {
            padding: 2rem;
        }

        /* FORM STYLES */
        .form-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-control,
        .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.85rem 1.15rem;
            transition: all 0.3s;
            font-size: 0.95rem;
            background-color: #f8f9fa;
        }

        .form-control:hover,
        .form-select:hover {
            border-color: #cbd5e0;
            background-color: white;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background-color: white;
            outline: none;
        }

        .form-control:disabled {
            background-color: #e9ecef;
            opacity: 0.7;
        }

        /* BUTTONS */
        .btn {
            padding: 0.75rem 1.75rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.5);
        }

        .btn-secondary {
            background: #6c757d;
            border: none;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(255, 193, 7, 0.5);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1.25rem;
            font-size: 0.875rem;
        }

        /* INFO DISPLAY */
        .info-row {
            padding: 1.25rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .info-value {
            font-size: 1.05rem;
            color: #2d3748;
            font-weight: 500;
        }

        /* BADGES */
        .badge {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .bg-primary {
            background: var(--primary-gradient) !important;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .main-content-modern {
                padding: 1.5rem;
            }

            .page-header {
                padding: 1.5rem;
            }

            .page-header h1 {
                font-size: 1.75rem;
            }

            .card-modern .card-body {
                padding: 1.5rem;
            }

            .notifications-dropdown {
                width: 320px !important;
            }
        }

        @media (max-width: 576px) {
            .notifications-dropdown {
                width: 280px !important;
            }
        }
    </style>
</head>

<body>

    <!-- Navbar Moderna -->
    <nav class="navbar-modern">
        <div class="container-fluid d-flex justify-content-between align-items-center h-100">
            <a href="index.html" class="navbar-brand-modern">
                <div class="logo-circle">
                    <i class="fas fa-robot"></i>
                </div>
                <span class="brand-text">ROBOTECH</span>
            </a>

            <div class="navbar-actions">
                <!-- Notificaciones -->
                <div class="dropdown">
                    <button class="notification-btn" id="notificacionesBtn" data-bs-toggle="dropdown"
                        data-bs-display="static" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificacionesBadge" style="display: none;">0</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end notifications-dropdown" id="notificacionesDropdownMenu">
                        <li class="dropdown-item-text text-center py-3">
                            <div class="spinner-border spinner-border-sm"></div>
                        </li>
                    </ul>
                </div>

                <!-- Usuario -->
                <div class="dropdown">
                    <div class="user-menu" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="user-name" id="usuarioNombre">Usuario</span>
                        <i class="fas fa-chevron-down" style="color: #6c757d; font-size: 0.8rem;"></i>
                    </div>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li class="px-3 py-2" style="border-bottom: 2px solid #f0f0f0;">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <div class="user-avatar" style="width: 40px; height: 40px;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: #2d3748; font-size: 0.95rem;"
                                        id="usuarioNombreMenu">Usuario</div>
                                    <div style="font-size: 0.8rem; color: #6c757d;" id="emailUsuarioNav"></div>
                                </div>
                            </div>
                        </li>
                        <li class="mt-2">
                            <a class="dropdown-item text-danger" href="#" onclick="logout()">
                                <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content-modern">
        <div class="container-fluid">

            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-user-edit"></i> Mi Perfil</h1>
            </div>

            <div class="row">

                <!-- Información del Perfil -->
                <div class="col-lg-8">

                    <!-- Datos Personales -->
                    <div class="card-modern">
                        <div class="card-header">
                            <h5>
                                <span><i class="fas fa-user"></i> Información Personal</span>
                                <button class="btn btn-sm btn-primary" onclick="mostrarFormularioEdicion()">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                            </h5>
                        </div>
                        <div class="card-body">

                            <!-- Vista de Información -->
                            <div id="vistaInfo">
                                <div class="text-center py-3">
                                    <div class="spinner-border text-primary">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Formulario de Edición -->
                            <form id="formEdicion" style="display: none;">

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Nombre Completo</label>
                                        <input type="text" class="form-control" id="nombreCompleto" maxlength="100">
                                        <div class="form-text">Opcional - Deja vacío para no cambiar</div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Apodo Personal</label>
                                        <input type="text" class="form-control" id="apodoPersonal" maxlength="50">
                                        <div class="form-text">2-50 caracteres - Opcional</div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" disabled>
                                    <div class="form-text">El email no puede cambiarse</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Teléfono</label>
                                    <input type="text" class="form-control" id="telefono" disabled>
                                    <div class="form-text">El teléfono no puede cambiarse</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Pregunta de Seguridad</label>
                                    <select class="form-select" id="preguntaSeguridad">
                                        <option value="">-- No cambiar --</option>
                                    </select>
                                    <div class="form-text">Si cambias la pregunta, debes proporcionar una respuesta
                                    </div>
                                </div>

                                <div class="mb-3" id="divRespuesta" style="display: none;">
                                    <label class="form-label">Respuesta de Seguridad <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="respuestaSeguridad">
                                    <div class="form-text">Requerido solo si cambiaste la pregunta</div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Guardar Cambios
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="cancelarEdicion()">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                </div>

                            </form>

                        </div>
                    </div>

                    <!-- Cambiar Contraseña -->
                    <div class="card-modern">
                        <div class="card-header">
                            <h5><i class="fas fa-key"></i> Cambiar Contraseña</h5>
                        </div>
                        <div class="card-body">

                            <form id="formPassword">

                                <div class="mb-3">
                                    <label class="form-label">Contraseña Actual <span
                                            class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="passwordActual" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Nueva Contraseña <span
                                            class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="passwordNueva" required
                                        minlength="8">
                                    <div class="form-text">Mínimo 8 caracteres</div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Confirmar Nueva Contraseña <span
                                            class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="confirmarPassword" required>
                                    <div id="passwordMatch" class="form-text"></div>
                                </div>

                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-lock"></i> Cambiar Contraseña
                                </button>

                            </form>

                        </div>
                    </div>

                </div>

                <!-- Información Adicional -->
                <div class="col-lg-4">

                    <!-- Resumen de Cuenta -->
                    <div class="card-modern">
                        <div class="card-header">
                            <h6><i class="fas fa-info-circle"></i> Resumen de Cuenta</h6>
                        </div>
                        <div class="card-body">
                            <div id="resumenCuenta">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ayuda -->
                    <div class="card-modern">
                        <div class="card-header">
                            <h6><i class="fas fa-question-circle"></i> Ayuda</h6>
                        </div>
                        <div class="card-body">
                            <p class="small mb-2"><strong>¿Olvidaste tu contraseña?</strong></p>
                            <p class="small text-muted mb-3">Usa la pregunta de seguridad en la página de login para
                                recuperarla.</p>
                        </div>
                    </div>

                </div>

            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/constants.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/notificaciones.js"></script>

    <script>
        // Proteger la página
        (function () {
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
        })();

        let datosUsuario = null;

        document.addEventListener('DOMContentLoaded', () => {
            const usuario = getCurrentUser();
            const nombreCompleto = usuario.nombreCompleto || 'Usuario';
            const email = usuario.email || '';

            // Actualizar navbar
            document.getElementById('usuarioNombre').textContent = nombreCompleto;
            document.getElementById('usuarioNombreMenu').textContent = nombreCompleto;
            document.getElementById('emailUsuarioNav').textContent = email;

            // Cargar datos
            cargarPerfil();
            cargarPreguntasSeguridad();

            // Event listeners
            document.getElementById('formEdicion').addEventListener('submit', guardarCambios);
            document.getElementById('formPassword').addEventListener('submit', cambiarPassword);
            document.getElementById('preguntaSeguridad').addEventListener('change', toggleRespuesta);
            document.getElementById('confirmarPassword').addEventListener('input', validarPasswordMatch);
        });

        async function cargarPerfil() {
            try {
                const result = await fetchAPI('/api/usuario/mi-informacion', 'GET');

                if (result.success && result.data) {
                    datosUsuario = result.data;
                    mostrarInformacion();
                    mostrarResumen();
                } else {
                    throw new Error(result.mensaje || 'No se pudo cargar el perfil');
                }
            } catch (error) {
                console.error('Error al cargar perfil:', error);
                await mostrarModalAlerta(
                    'Error',
                    'No se pudo cargar la información del perfil',
                    'error'
                );
            }
        }

        function mostrarInformacion() {
            const vistaDiv = document.getElementById('vistaInfo');
            vistaDiv.innerHTML = `
                <div class="info-row">
                    <div class="info-label">Nombre Completo</div>
                    <div class="info-value">${escaparHTML(datosUsuario.nombreCompleto || 'No especificado')}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Apodo Personal</div>
                    <div class="info-value">${escaparHTML(datosUsuario.apodoPersonal || 'No especificado')}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Email</div>
                    <div class="info-value">${escaparHTML(datosUsuario.email)}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Teléfono</div>
                    <div class="info-value">${escaparHTML(datosUsuario.telefono || 'No especificado')}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Fecha de Registro</div>
                    <div class="info-value">${formatearFecha(datosUsuario.fechaRegistro, true)}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Pregunta de Seguridad</div>
                    <div class="info-value">${escaparHTML(datosUsuario.preguntaSeguridad || 'No configurada')}</div>
                </div>`;
        }

        function mostrarResumen() {
            const resumenDiv = document.getElementById('resumenCuenta');
            const ultimoAcceso = datosUsuario.ultimoInicioSesion
                ? formatearFecha(datosUsuario.ultimoInicioSesion, true)
                : 'Nunca';

            let rolesHTML = '';
            if (datosUsuario.roles && Array.isArray(datosUsuario.roles) && datosUsuario.roles.length > 0) {
                rolesHTML = datosUsuario.roles.map(rol => {
                    const nombreRol = typeof rol === 'string' ? rol : (rol.nombreRol || rol);
                    return `<span class="badge bg-primary me-1 mb-1">${escaparHTML(nombreRol)}</span>`;
                }).join('');
            } else {
                rolesHTML = '<span class="badge bg-secondary">Sin roles</span>';
            }

            resumenDiv.innerHTML = `
                <div class="info-row">
                    <div class="info-label">Último acceso</div>
                    <div class="info-value">${ultimoAcceso}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Roles Asignados</div>
                    <div>${rolesHTML}</div>
                </div>`;
        }

        function cargarPreguntasSeguridad() {
            const select = document.getElementById('preguntaSeguridad');
            PREGUNTAS_SEGURIDAD.forEach(pregunta => {
                const option = document.createElement('option');
                option.value = pregunta;
                option.textContent = pregunta;
                select.appendChild(option);
            });
        }

        function mostrarFormularioEdicion() {
            document.getElementById('vistaInfo').style.display = 'none';
            const form = document.getElementById('formEdicion');
            form.style.display = 'block';
            document.getElementById('nombreCompleto').value = datosUsuario.nombreCompleto || '';
            document.getElementById('apodoPersonal').value = datosUsuario.apodoPersonal || '';
            document.getElementById('email').value = datosUsuario.email;
            document.getElementById('telefono').value = datosUsuario.telefono || '';
            document.getElementById('preguntaSeguridad').value = '';
            document.getElementById('respuestaSeguridad').value = '';
        }

        function cancelarEdicion() {
            document.getElementById('vistaInfo').style.display = 'block';
            document.getElementById('formEdicion').style.display = 'none';
            document.getElementById('formEdicion').reset();
            document.getElementById('divRespuesta').style.display = 'none';
        }

        function toggleRespuesta() {
            const pregunta = document.getElementById('preguntaSeguridad').value;
            const divRespuesta = document.getElementById('divRespuesta');
            if (pregunta) {
                divRespuesta.style.display = 'block';
                document.getElementById('respuestaSeguridad').required = true;
            } else {
                divRespuesta.style.display = 'none';
                document.getElementById('respuestaSeguridad').required = false;
            }
        }

        async function guardarCambios(e) {
            e.preventDefault();
            const nombreCompleto = document.getElementById('nombreCompleto').value.trim();
            const apodoPersonal = document.getElementById('apodoPersonal').value.trim();
            const preguntaSeguridad = document.getElementById('preguntaSeguridad').value;
            const respuestaSeguridad = document.getElementById('respuestaSeguridad').value.trim();

            if (apodoPersonal && (apodoPersonal.length < 2 || apodoPersonal.length > 50)) {
                await mostrarModalAlerta(
                    'Error de Validación',
                    'El apodo debe tener entre 2 y 50 caracteres',
                    'warning'
                );
                return;
            }

            if (preguntaSeguridad && !respuestaSeguridad) {
                await mostrarModalAlerta(
                    'Error de Validación',
                    'Debes proporcionar una respuesta para la pregunta de seguridad',
                    'warning'
                );
                return;
            }

            const datosActualizados = {};
            if (nombreCompleto) datosActualizados.nombreCompleto = nombreCompleto;
            if (apodoPersonal) datosActualizados.apodoPersonal = apodoPersonal;
            if (preguntaSeguridad) {
                datosActualizados.preguntaSeguridad = preguntaSeguridad;
                datosActualizados.respuestaSeguridad = respuestaSeguridad;
            }

            if (Object.keys(datosActualizados).length === 0) {
                await mostrarModalAlerta(
                    'Sin Cambios',
                    'No hay cambios para guardar',
                    'info'
                );
                return;
            }

            mostrarLoading();

            try {
                let result = await fetchAPI('/api/usuario/perfil', 'PUT', datosActualizados);
                ocultarLoading();

                if (result.success) {
                    // Actualizar localStorage si cambió el nombre
                    if (nombreCompleto) {
                        const usuario = getCurrentUser();
                        usuario.nombreCompleto = nombreCompleto;
                        localStorage.setItem('usuario', JSON.stringify(usuario));
                        document.getElementById('usuarioNombre').textContent = nombreCompleto;
                        document.getElementById('usuarioNombreMenu').textContent = nombreCompleto;
                    }

                    await mostrarModalAlerta(
                        'Perfil Actualizado',
                        'Tu información ha sido actualizada exitosamente',
                        'success'
                    );

                    await cargarPerfil();
                    cancelarEdicion();
                } else {
                    await mostrarModalAlerta(
                        'Error',
                        result.mensaje || 'Error al actualizar perfil',
                        'error'
                    );
                }
            } catch (error) {
                ocultarLoading();
                console.error('Error:', error);
                await mostrarModalAlerta(
                    'Error de Conexión',
                    'No se pudo conectar con el servidor',
                    'error'
                );
            }
        }

        function validarPasswordMatch() {
            const nueva = document.getElementById('passwordNueva').value;
            const confirmar = document.getElementById('confirmarPassword').value;
            const matchDiv = document.getElementById('passwordMatch');

            if (confirmar === '') {
                matchDiv.textContent = '';
                matchDiv.className = 'form-text';
            } else if (nueva === confirmar) {
                matchDiv.textContent = '✓ Las contraseñas coinciden';
                matchDiv.className = 'form-text text-success';
            } else {
                matchDiv.textContent = '✗ Las contraseñas no coinciden';
                matchDiv.className = 'form-text text-danger';
            }
        }

        async function cambiarPassword(e) {
            e.preventDefault();
            const passwordActual = document.getElementById('passwordActual').value;
            const passwordNueva = document.getElementById('passwordNueva').value;
            const confirmarPassword = document.getElementById('confirmarPassword').value;

            if (passwordNueva.length < 8) {
                await mostrarModalAlerta(
                    'Error de Validación',
                    'La nueva contraseña debe tener al menos 8 caracteres',
                    'warning'
                );
                return;
            }

            if (passwordNueva !== confirmarPassword) {
                await mostrarModalAlerta(
                    'Error de Validación',
                    'Las contraseñas no coinciden',
                    'warning'
                );
                return;
            }

            if (passwordActual === passwordNueva) {
                await mostrarModalAlerta(
                    'Error de Validación',
                    'La nueva contraseña debe ser diferente a la actual',
                    'warning'
                );
                return;
            }

            const confirmar = await confirmarModal(
                '¿Cambiar contraseña?',
                '¿Estás seguro de cambiar tu contraseña?',
                'Cambiar',
                'Cancelar'
            );

            if (!confirmar) return;

            mostrarLoading();

            try {
                const result = await fetchAPI('/api/usuario/cambiar-password', 'PUT', {
                    passwordActual,
                    passwordNueva
                });

                ocultarLoading();

                if (result.success) {
                    await mostrarModalAlerta(
                        'Contraseña Cambiada',
                        'Tu contraseña ha sido actualizada exitosamente',
                        'success'
                    );
                    document.getElementById('formPassword').reset();
                    document.getElementById('passwordMatch').textContent = '';
                } else {
                    await mostrarModalAlerta(
                        'Error',
                        result.mensaje || 'Error al cambiar contraseña',
                        'error'
                    );
                }
            } catch (error) {
                ocultarLoading();
                console.error('Error:', error);
                await mostrarModalAlerta(
                    'Error de Conexión',
                    'No se pudo conectar con el servidor',
                    'error'
                );
            }
        }
    </script>
</body>

</html>